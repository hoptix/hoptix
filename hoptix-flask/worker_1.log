2025-08-25 00:32:42,621:INFO - OpenAI API key found
2025-08-25 00:32:42,621:INFO - Loaded environment variables - AWS Region: us-east-2
2025-08-25 00:32:42,621:INFO - === Starting batch video processing (process all 'uploaded') ===
2025-08-25 00:32:42,621:INFO - Initializing database and S3 connections...
2025-08-25 00:32:42,659:INFO - Found credentials in shared credentials file: ~/.aws/credentials
2025-08-25 00:32:42,765:INFO - Successfully connected to database and S3
2025-08-25 00:32:43,090:INFO - HTTP Request: GET https://ohuumgemptxrqrdavslz.supabase.co/rest/v1/videos?select=id%2C%20s3_key%2C%20run_id%2C%20location_id%2C%20started_at%2C%20ended_at&status=eq.uploaded&limit=1 "HTTP/1.1 200 OK"
2025-08-25 00:32:43,142:INFO - Found video to process - ID: c613a9f9-4f88-4e30-98d2-ec96e9e67292, S3 Key: dev/sample/DT_File20250817120001000.avi
2025-08-25 00:32:43,143:INFO - Attempting to claim video c613a9f9-4f88-4e30-98d2-ec96e9e67292...
2025-08-25 00:32:43,230:INFO - HTTP Request: PATCH https://ohuumgemptxrqrdavslz.supabase.co/rest/v1/videos?id=eq.c613a9f9-4f88-4e30-98d2-ec96e9e67292&status=eq.uploaded "HTTP/1.1 200 OK"
2025-08-25 00:32:43,230:INFO - Successfully claimed video c613a9f9-4f88-4e30-98d2-ec96e9e67292
2025-08-25 00:32:43,230:INFO - Starting video processing for c613a9f9-4f88-4e30-98d2-ec96e9e67292...
2025-08-25 00:32:43,230:INFO - Starting video processing pipeline for c613a9f9-4f88-4e30-98d2-ec96e9e67292
2025-08-25 00:32:43,233:INFO - Downloading video c613a9f9-4f88-4e30-98d2-ec96e9e67292 from S3: dev/sample/DT_File20250817120001000.avi
2025-08-25 00:33:03,370:INFO - Downloaded video to: /var/folders/pl/7l52nm4d7zgdj2mnsccc2yyw0000gn/T/hoptix_qnkxs5ep/input.mp4
2025-08-25 00:33:03,371:INFO - Starting transcription for video c613a9f9-4f88-4e30-98d2-ec96e9e67292
2025-08-25 00:33:20,159:INFO - HTTP Request: POST https://api.openai.com/v1/audio/transcriptions "HTTP/1.1 200 OK"
2025-08-25 00:33:23,092:INFO - HTTP Request: POST https://api.openai.com/v1/audio/transcriptions "HTTP/1.1 200 OK"
2025-08-25 00:33:23,095:INFO - Transcription completed: 2 segments generated
2025-08-25 00:33:23,096:INFO - Starting transaction splitting for video c613a9f9-4f88-4e30-98d2-ec96e9e67292
2025-08-25 00:33:31,220:INFO - HTTP Request: POST https://api.openai.com/v1/responses "HTTP/1.1 200 OK"
2025-08-25 00:33:36,764:INFO - HTTP Request: POST https://api.openai.com/v1/responses "HTTP/1.1 200 OK"
2025-08-25 00:33:36,766:INFO - Transaction splitting completed: 2 transactions identified
2025-08-25 00:33:36,766:INFO - Uploading artifacts to S3 with prefix: deriv/session=c613a9f9-4f88-4e30-98d2-ec96e9e67292/
2025-08-25 00:33:37,144:INFO - Artifacts uploaded to S3
2025-08-25 00:33:37,144:INFO - Inserting 2 transactions into database
2025-08-25 00:33:37,144:INFO - Transaction 1: 2025-08-17T12:00:31Z to 2025-08-17T12:01:16Z (video seconds 30.0-75.0)
2025-08-25 00:33:37,144:INFO - Transaction 2: 2025-08-17T12:14:01Z to 2025-08-17T12:14:56.570000Z (video seconds 840.0-895.57)
2025-08-25 00:33:37,146:INFO - Saved 2 transaction records to exports/20250825_003337_transactions.csv
2025-08-25 00:33:37,613:INFO - HTTP Request: POST https://ohuumgemptxrqrdavslz.supabase.co/rest/v1/transactions "HTTP/1.1 201 Created"
2025-08-25 00:33:37,618:INFO - Inserted transactions with IDs: ['e56a42b8-0e1a-495a-983f-95888f28aa9d', 'd9bab138-a320-4070-a765-c93b1496d9c4']
2025-08-25 00:33:37,618:INFO - Starting grading for 2 transactions
2025-08-25 00:34:19,250:INFO - HTTP Request: POST https://api.openai.com/v1/responses "HTTP/1.1 200 OK"
2025-08-25 00:34:42,639:INFO - HTTP Request: POST https://api.openai.com/v1/responses "HTTP/1.1 200 OK"
Using video timestamp from filename: 2025-08-17T12:00:01Z

=== STEP 1 (Transaction Splitting) RAW OUTPUT ===
Input transcript: So, green number four, and it was two with spray, and what was the last one? Did you want medium or large drinks for that? Okay, and then we can do chips or pretzel sticks. So we have pretzel sticks, ...
Raw LLM response: {"1":"Operator: So, green number four, and it was two with spray, and what was the last one?\nOperator: Did you want medium or large drinks for that?\nOperator: Okay, and then we can do chips or pretzel sticks.\nOperator: So we have pretzel sticks, Lay's chips, barbecue chips, or Doritos.\nOperator: Okay, for all of them?\nOperator: Anything else?","2":"0","3":"0","4":"0","5":"0","6":"0"}
==================================================

=== STEP 1 (Transaction Splitting) RAW OUTPUT ===
Input transcript: Can I do a strawberry Julius and a strawberry banana Julius, please?
...
Raw LLM response: {"1": "Customer: Can I do a strawberry Julius and a strawberry banana Julius, please?", "2": "0", "3": "0", "4": "0", "5": "0", "6": "0"}
==================================================

=== STEP 2 (Grading) RAW OUTPUT ===
Input transcript: Operator: So, green number four, and it was two with spray, and what was the last one?
Operator: Did you want medium or large drinks for that?
Operator: Okay, and then we can do chips or pretzel stick...
Raw LLM response: {"1":"Number 4 Meal (Burger, Fries, Small Drink)","2":3,"3":0,"4":0,"5":0,"6":0,"7":0,"8":1,"9":1,"10":"Drink","11":1,"12":0,"13":0,"14":0,"15":0,"16":0,"17":0,"18":0,"19":"Number 4 Meal (Burger, Fries, Small Drink)","20":3,"21":"The operator correctly identified one opportunity to upsize the meal’s drink and offered medium or large, which includes the largest size and thus counts as a valid upsizing offer. No upsell or topping offers were attempted, and the customer’s acceptance of the upsizing offer was not confirmed, so no successes could be recorded. Capturing customer responses and explicitly suggesting the large size only would improve effectiveness.","22":"Transcript contains only the operator’s side of the conversation, leaving the customer’s exact order, quantities, and acceptance decisions unknown. Assumptions had to be made to log at least one meal with a drink so that the upsizing interaction could be assessed, but actual counts and outcomes remain uncertain."}
==================================================
Parsed JSON: {'1': 'Number 4 Meal (Burger, Fries, Small Drink)', '2': 3, '3': 0, '4': 0, '5': 0, '6': 0, '7': 0, '8': 1, '9': 1, '10': 'Drink', '11': 1, '12': 0, '13': 0, '14': 0, '15': 0, '16': 0, '17': 0, '18': 0, '19': 'Number 4 Meal (Burger, Fries, Small Drink)', '20': 3, '21': 'The operator correctly identified one opportunity to upsize the meal’s drink and offered medium or large, which includes the largest size and thus counts as a valid upsizing offer. No upsell or topping offers were attempted, and the customer’s acceptance of the upsizing offer was not confirmed, so no successes could be recorded. Capturing customer responses and explicitly suggesting the large size only would improve effectiveness.', '22': 'Transcript contains only the operator’s side of the conversation, leaving the customer’s exact order, quantities, and acceptance decisions unknown. Assumptions had to be made to log at least one meal with a drink so that the upsizing interaction could be assessed, but actual counts and outcomes remain uncertain.'}
GPT Price: $31.444000 (input: 4730 tokens, output: 2748 tokens)
==================================================
Mapped details: {'complete_order': 0, 'mobile_order': 0, 'coupon_used': 0, 'asked_more_time': 0, 'out_of_stock_items': '0', 'items_initial': 'Number 4 Meal (Burger, Fries, Small Drink)', 'num_items_initial': 3, 'num_upsell_opportunities': 0, 'items_upsellable': 0, 'num_upsell_offers': 0, 'items_upsold': 0, 'num_upsell_success': 0, 'num_largest_offers': 1, 'num_upsize_opportunities': 1, 'items_upsizeable': 'Drink', 'num_upsize_offers': 1, 'num_upsize_success': 0, 'items_upsize_success': 0, 'num_addon_opportunities': 0, 'items_addonable': 0, 'num_addon_offers': 0, 'num_addon_success': 0, 'items_addon_success': 0, 'items_after': 'Number 4 Meal (Burger, Fries, Small Drink)', 'num_items_after': 3, 'feedback': 'The operator correctly identified one opportunity to upsize the meal’s drink and offered medium or large, which includes the largest size and thus counts as a valid upsizing offer. No upsell or topping offers were attempted, and the customer’s acceptance of the upsizing offer was not confirmed, so no successes could be recorded. Capturing customer responses and explicitly suggesting the large size only would improve effectiveness.', 'issues': 'Transcript contains only the operator’s side of the conversation, leaving the customer’s exact order, quantities, and acceptance decisions unknown. Assumptions had to be made to log at least one meal with a drink so that the upsizing interaction could be assessed, but actual counts and outcomes remain uncertain.', 'reasoning_summary': '', 'gpt_price': 0, 'video_file_path': '', 'video_link': ''}
==================================================

=== STEP 2 (Grading) RAW OUTPUT ===
Input transcript: Customer: Can I do a strawberry Julius and a strawberry banana Julius, please?...
Raw LLM response: {"1": "Strawberry Julius, Strawberry Banana Julius", "2": 2, "3": 0, "4": 0, "5": 0, "6": 0, "7": 0, "8": 0, "9": 2, "10": "Strawberry Julius, Strawberry Banana Julius", "11": 0, "12": 0, "13": 0, "14": 2, "15": "Strawberry Julius, Strawberry Banana Julius", "16": 0, "17": 0, "18": 0, "19": "Strawberry Julius, Strawberry Banana Julius", "20": 2, "21": "The operator did not attempt any upsell, upsize, or add-on despite two clear opportunities to suggest larger sizes or banana boosts for both Julius drinks. Training should emphasize prompting with a friendly offer for large drinks and suggesting popular add-ons to increase check averages.", "22": "Transcript contained only the customer’s order with no operator response, making it impossible to capture any offers or successful conversions."}
==================================================
Parsed JSON: {'1': 'Strawberry Julius, Strawberry Banana Julius', '2': 2, '3': 0, '4': 0, '5': 0, '6': 0, '7': 0, '8': 0, '9': 2, '10': 'Strawberry Julius, Strawberry Banana Julius', '11': 0, '12': 0, '13': 0, '14': 2, '15': 'Strawberry Julius, Strawberry Banana Julius', '16': 0, '17': 0, '18': 0, '19': 'Strawberry Julius, Strawberry Banana Julius', '20': 2, '21': 'The operator did not attempt any upsell, upsize, or add-on despite two clear opportunities to suggest larger sizes or banana boosts for both Julius drinks. Training should emphasize prompting with a friendly offer for large drinks and suggesting popular add-ons to increase check averages.', '22': 'Transcript contained only the customer’s order with no operator response, making it impossible to capture any offers or successful conversions.'}
GPT Price: $20.462000 (input: 4663 tokens, output: 1392 tokens)
==================================================
2025-08-25 00:34:42,999:INFO - Grading completed and uploaded to S3
2025-08-25 00:34:42,999:INFO - Upserting grades for 2 transactions
2025-08-25 00:34:43,006:INFO - Saved 2 grade records to exports/20250825_003442_grades.csv
2025-08-25 00:34:43,301:INFO - HTTP Request: POST https://ohuumgemptxrqrdavslz.supabase.co/rest/v1/grades?on_conflict=transaction_id "HTTP/1.1 201 Created"
2025-08-25 00:34:43,301:INFO - Grades upsertion completed
2025-08-25 00:34:43,301:INFO - Starting clip generation for 2 transactions
2025-08-25 00:34:43,409:INFO - HTTP Request: GET https://ohuumgemptxrqrdavslz.supabase.co/rest/v1/transactions?select=id%2C%20started_at%2C%20ended_at%2C%20meta&id=in.%28e56a42b8-0e1a-495a-983f-95888f28aa9d%2Cd9bab138-a320-4070-a765-c93b1496d9c4%29 "HTTP/1.1 200 OK"
2025-08-25 00:34:43,422:INFO - Generating clip for transaction e56a42b8-0e1a-495a-983f-95888f28aa9d
2025-08-25 00:34:43,942:INFO - HTTP Request: GET https://ohuumgemptxrqrdavslz.supabase.co/rest/v1/runs?select=run_date%2C%20locations%21inner%28name%2C%20orgs%21inner%28name%29%29&id=eq.63c4ff8a-2fe7-46ae-a40b-2d075434da78&limit=1 "HTTP/1.1 200 OK"
2025-08-25 00:34:47,923:INFO - HTTP Request: PATCH https://ohuumgemptxrqrdavslz.supabase.co/rest/v1/transactions?id=eq.e56a42b8-0e1a-495a-983f-95888f28aa9d "HTTP/1.1 200 OK"
2025-08-25 00:34:47,927:INFO - Successfully generated and uploaded clip for transaction e56a42b8-0e1a-495a-983f-95888f28aa9d: https://hoptix-deriv-devprod.s3.us-east-2.amazonaws.com/clips/TestOrg_TestLocation_2025_08_25/12_00_01/tx=e56a42b8-0e1a-495a-983f-95888f28aa9d.mp4
2025-08-25 00:34:47,927:INFO - Generating clip for transaction d9bab138-a320-4070-a765-c93b1496d9c4
2025-08-25 00:34:48,255:INFO - HTTP Request: GET https://ohuumgemptxrqrdavslz.supabase.co/rest/v1/runs?select=run_date%2C%20locations%21inner%28name%2C%20orgs%21inner%28name%29%29&id=eq.63c4ff8a-2fe7-46ae-a40b-2d075434da78&limit=1 "HTTP/1.1 200 OK"
2025-08-25 00:34:52,002:INFO - HTTP Request: PATCH https://ohuumgemptxrqrdavslz.supabase.co/rest/v1/transactions?id=eq.d9bab138-a320-4070-a765-c93b1496d9c4 "HTTP/1.1 200 OK"
2025-08-25 00:34:52,003:INFO - Successfully generated and uploaded clip for transaction d9bab138-a320-4070-a765-c93b1496d9c4: https://hoptix-deriv-devprod.s3.us-east-2.amazonaws.com/clips/TestOrg_TestLocation_2025_08_25/12_14_14/tx=d9bab138-a320-4070-a765-c93b1496d9c4.mp4
2025-08-25 00:34:52,003:INFO - Clip generation completed for video c613a9f9-4f88-4e30-98d2-ec96e9e67292
2025-08-25 00:34:52,003:INFO - Successfully completed all processing steps for video c613a9f9-4f88-4e30-98d2-ec96e9e67292
2025-08-25 00:34:52,020:INFO - Cleaned up temporary files for video c613a9f9-4f88-4e30-98d2-ec96e9e67292
2025-08-25 00:34:52,147:INFO - HTTP Request: PATCH https://ohuumgemptxrqrdavslz.supabase.co/rest/v1/videos?id=eq.c613a9f9-4f88-4e30-98d2-ec96e9e67292 "HTTP/1.1 200 OK"
2025-08-25 00:34:52,148:INFO - ✅ Successfully processed video c613a9f9-4f88-4e30-98d2-ec96e9e67292 in 128.79 seconds
2025-08-25 00:34:52,224:INFO - HTTP Request: GET https://ohuumgemptxrqrdavslz.supabase.co/rest/v1/videos?select=id%2C%20s3_key%2C%20run_id%2C%20location_id%2C%20started_at%2C%20ended_at&status=eq.uploaded&limit=1 "HTTP/1.1 200 OK"
2025-08-25 00:34:52,224:INFO - No more uploaded videos found in queue.
2025-08-25 00:34:52,224:INFO - Batch complete. Succeeded: 1, Failed: 0, Total: 1
2025-08-25 00:34:52,224:INFO - Processed video IDs: c613a9f9-4f88-4e30-98d2-ec96e9e67292
2025-08-25 00:34:52,225:INFO - === Batch session completed in 129.60 seconds ===
Mapped details: {'complete_order': 0, 'mobile_order': 0, 'coupon_used': 0, 'asked_more_time': 0, 'out_of_stock_items': '0', 'items_initial': 'Strawberry Julius, Strawberry Banana Julius', 'num_items_initial': 2, 'num_upsell_opportunities': 0, 'items_upsellable': 0, 'num_upsell_offers': 0, 'items_upsold': 0, 'num_upsell_success': 0, 'num_largest_offers': 0, 'num_upsize_opportunities': 2, 'items_upsizeable': 'Strawberry Julius, Strawberry Banana Julius', 'num_upsize_offers': 0, 'num_upsize_success': 0, 'items_upsize_success': 0, 'num_addon_opportunities': 2, 'items_addonable': 'Strawberry Julius, Strawberry Banana Julius', 'num_addon_offers': 0, 'num_addon_success': 0, 'items_addon_success': 0, 'items_after': 'Strawberry Julius, Strawberry Banana Julius', 'num_items_after': 2, 'feedback': 'The operator did not attempt any upsell, upsize, or add-on despite two clear opportunities to suggest larger sizes or banana boosts for both Julius drinks. Training should emphasize prompting with a friendly offer for large drinks and suggesting popular add-ons to increase check averages.', 'issues': 'Transcript contained only the customer’s order with no operator response, making it impossible to capture any offers or successful conversions.', 'reasoning_summary': '', 'gpt_price': 0, 'video_file_path': '', 'video_link': ''}
==================================================
Clip timing debug:
  Video start: 2025-08-25T04:20:08+00:00
  Transaction start: 2025-08-17T12:00:31+00:00
  Transaction end: 2025-08-17T12:01:16+00:00
  Start offset: 31.000s
  End offset: 76.000s
  Clip duration: 45.000s
Video name debug:
  Transaction started_at: 2025-08-17T12:00:31+00:00
  Transaction ended_at: 2025-08-17T12:01:16+00:00
  Generated name: 12_00_01
Clip timing debug:
  Video start: 2025-08-25T04:20:08+00:00
  Transaction start: 2025-08-17T12:14:01+00:00
  Transaction end: 2025-08-17T12:14:56.57+00:00
  Start offset: 841.000s
  End offset: 896.570s
  Clip duration: 55.570s
Video name debug:
  Transaction started_at: 2025-08-17T12:14:01+00:00
  Transaction ended_at: 2025-08-17T12:14:56.57+00:00
  Generated name: 12_14_14
